---
- name: Capture OpenWrt configuration snapshot
  hosts: openwrt
  gather_facts: false
  vars:
    snapshot_ts: "{{ lookup('pipe', 'date -u +%Y%m%dT%H%M%SZ') }}"
    snapshot_dir: "{{ openwrt_snapshot_root }}/{{ openwrt_router_name }}/{{ snapshot_ts }}"
    uci_files: "{{ openwrt_uci_files | default([]) }}"
  tasks:
    - name: Ensure snapshot directory exists
      ansible.builtin.file:
        path: "{{ snapshot_dir }}"
        state: directory
        mode: "0750"
      delegate_to: localhost
      run_once: true

    - name: Fetch UCI configuration files
      ansible.builtin.fetch:
        src: "{{ openwrt_config_dir }}/{{ item }}"
        dest: "{{ snapshot_dir }}/{{ item }}"
        flat: true
        fail_on_missing: true
      loop: "{{ uci_files }}"

    - name: Set snapshot files to read-only
      ansible.builtin.file:
        path: "{{ snapshot_dir }}/{{ item }}"
        mode: "0440"
      loop: "{{ uci_files }}"
      delegate_to: localhost
      run_once: true
