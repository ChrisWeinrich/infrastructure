---
- name: Apply OpenWrt configuration in staged steps
  hosts: openwrt
  gather_facts: false
  strategy: linear
  vars:
    # Snapshot only the configured UCI files.
    uci_files: "{{ openwrt_uci_files | default([]) }}"
    # Reserved for staged apply extensions.
    openwrt_apply_full: false
    # Reserved for staged apply extensions.
    openwrt_apply_pause: true
  tasks:
    # Sync repository UCI files to the router before enabling services.
    - name: Apply repository UCI configuration files
      ansible.builtin.include_role:
        name: openwrt/uci

    # Ensure Tailscale is installed and configured.
    - name: Apply Tailscale role
      ansible.builtin.include_role:
        name: openwrt/tailscale

    # Restart core services to apply configuration changes.
    - name: Restart dnsmasq
      ansible.builtin.raw: "/etc/init.d/dnsmasq restart"
      changed_when: true

    - name: Restart firewall
      ansible.builtin.raw: "/etc/init.d/firewall restart"
      changed_when: true

    # Best practice for OpenWrt without Python:
    # - Fire-and-forget network restart via nohup
    # - Expect SSH to drop
    # - Next playbook run verifies state

    - name: Restart network (detached, SSH may drop)
      ansible.builtin.raw: "nohup sh -c '/etc/init.d/network restart' >/tmp/net-restart.log 2>&1 &"
      changed_when: true
      failed_when: false

  handlers: []
