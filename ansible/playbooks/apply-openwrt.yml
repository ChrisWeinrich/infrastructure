---
- name: Apply OpenWrt configuration in staged steps
  hosts: openwrt
  gather_facts: false
  strategy: linear
  vars:
    # Snapshot only the configured UCI files.
    uci_files: "{{ openwrt_uci_files | default([]) }}"
    # Reserved for staged apply extensions.
    openwrt_apply_full: false
    # Reserved for staged apply extensions.
    openwrt_apply_pause: true
    network_config_path: "{{ playbook_dir }}/../configs/network.yml"
  tasks:
    # Resolve the snapshot root directory on the control host.
    - name: Set snapshot root
      ansible.builtin.set_fact:
        snapshot_root: >-
          {{ lookup('pipe', 'cd ' + playbook_dir + '/../.. && pwd')
             ~ '/' ~ (openwrt_snapshot_root | default('snapshots')) }}
      delegate_to: localhost
      run_once: true

    # Use a UTC timestamp so snapshots are sortable and unambiguous.
    - name: Set snapshot timestamp
      ansible.builtin.set_fact:
        snapshot_ts: "{{ lookup('pipe', 'date -u +%Y%m%dT%H%M%SZ') }}"
      delegate_to: localhost
      run_once: true

    # Compose the router-specific snapshot directory path.
    - name: Set snapshot directory
      ansible.builtin.set_fact:
        snapshot_dir: "{{ snapshot_root }}/{{ openwrt_router_name }}/{{ snapshot_ts }}"
      delegate_to: localhost
      run_once: true

    # Ensure the snapshot directory exists before writing files.
    - name: Ensure snapshot directory exists
      ansible.builtin.file:
        path: "{{ snapshot_dir }}"
        state: directory
        mode: "0750"
      delegate_to: localhost
      run_once: true

    # Read each UCI config file from the router.
    - name: Read UCI configuration files
      ansible.builtin.raw: "cat {{ openwrt_config_dir }}/{{ item }}"
      loop: "{{ uci_files }}"
      register: openwrt_configs
      changed_when: false

    # Write snapshot files locally, stripping wireless keys for safety.
    - name: Write snapshot files
      ansible.builtin.copy:
        dest: "{{ snapshot_dir }}/{{ item.item }}"
        content: >-
          {{ (item.stdout
          | replace("\r", "")
          | regex_replace("(?m)^.*option key.*\\n?", ""))
          if item.item == 'wireless' else (item.stdout | replace("\r", "")) }}
        mode: "0440"
      loop: "{{ openwrt_configs.results }}"
      delegate_to: localhost
      run_once: true

    # Remove any remaining wireless key lines from the snapshot.
    - name: Strip wireless keys from snapshot
      ansible.builtin.lineinfile:
        path: "{{ snapshot_dir }}/wireless"
        regexp: "^[[:space:]]*option[[:space:]]+key[[:space:]]+"
        state: absent
      when: "'wireless' in uci_files"
      delegate_to: localhost
      run_once: true

    # Normalize line endings to avoid diffs caused by CRLF.
    - name: Normalize wireless snapshot line endings
      ansible.builtin.replace:
        path: "{{ snapshot_dir }}/wireless"
        regexp: "\\r$"
        replace: ""
      when: "'wireless' in uci_files"
      delegate_to: localhost
      run_once: true

    # Sync repository UCI files to the router before enabling services.
    - name: Apply repository UCI configuration files
      ansible.builtin.include_tasks: tasks/apply-openwrt-uci.yml

    - name: Load central network configuration
      ansible.builtin.include_vars:
        file: "{{ network_config_path }}"
        name: network_config

    - name: Select VLAN 40 and service configuration
      ansible.builtin.set_fact:
        vlan40_config: "{{ network_config.site.networks.vlan40 }}"
        vlan40_service: "{{ network_config.site.services.hello_world_nginx }}"
        vlan40_device_name: >-
          {{ network_config.site.networks.vlan40.uplink }}
          .{{ network_config.site.networks.vlan40.vlan_id }}

    - name: Validate VLAN 40 configuration values
      ansible.builtin.assert:
        that:
          - vlan40_config.vlan_id is defined
          - vlan40_config.gateway is string
          - vlan40_config.subnet is string
          - vlan40_config.uplink is string
          - vlan40_service.address is defined
          - vlan40_service.hostname is defined
        fail_msg: "VLAN 40 configuration is incomplete in network.yml."
        success_msg: "VLAN 40 configuration is present."

    - name: Configure VLAN 40 interface on OpenWrt
      ansible.builtin.raw: |
        uci -q batch <<'EOF'
        set network.vlan40_dev=device
        set network.vlan40_dev.type='8021q'
        set network.vlan40_dev.ifname='{{ vlan40_config.uplink }}'
        set network.vlan40_dev.vid='{{ vlan40_config.vlan_id }}'
        set network.vlan40=interface
        set network.vlan40.device='{{ vlan40_device_name }}'
        set network.vlan40.proto='static'
        set network.vlan40.ipaddr='{{ vlan40_config.gateway }}'
        set network.vlan40.netmask='255.255.255.0'
        commit network
        EOF

    - name: Reload network for VLAN 40
      ansible.builtin.raw: "/etc/init.d/network reload"
      changed_when: false

    - name: Configure firewall zone for VLAN 40
      ansible.builtin.raw: |
        uci -q batch <<'EOF'
        delete firewall.vlan40
        set firewall.vlan40=zone
        set firewall.vlan40.name='vlan40'
        set firewall.vlan40.input='ACCEPT'
        set firewall.vlan40.output='ACCEPT'
        set firewall.vlan40.forward='REJECT'
        set firewall.vlan40.network='vlan40'
        commit firewall
        EOF

    - name: Configure firewall forwarding from LAN to VLAN 40
      ansible.builtin.raw: |
        src='lan'
        dest='vlan40'
        rule_exists="$(uci -q show firewall | grep -F "forwarding" | grep -F "src='${src}'" | grep -F "dest='${dest}'" | head -n1)"
        if [ -z "${rule_exists}" ]; then
          section="$(uci add firewall forwarding)"
          uci set firewall.${section}.src="${src}"
          uci set firewall.${section}.dest="${dest}"
          uci commit firewall
          echo changed
        fi
      register: vlan40_forward_lan
      changed_when: "'changed' in vlan40_forward_lan.stdout"

    - name: Configure firewall forwarding from Tailscale to VLAN 40
      ansible.builtin.raw: |
        src='tailscale'
        dest='vlan40'
        rule_exists="$(uci -q show firewall | grep -F "forwarding" | grep -F "src='${src}'" | grep -F "dest='${dest}'" | head -n1)"
        if [ -z "${rule_exists}" ]; then
          section="$(uci add firewall forwarding)"
          uci set firewall.${section}.src="${src}"
          uci set firewall.${section}.dest="${dest}"
          uci commit firewall
          echo changed
        fi
      register: vlan40_forward_tailscale
      changed_when: "'changed' in vlan40_forward_tailscale.stdout"

    - name: Reload firewall after VLAN 40 changes
      ansible.builtin.raw: "/etc/init.d/firewall reload"
      changed_when: false

    - name: Configure DNS hostname for VLAN service
      ansible.builtin.raw: |
        hostname="{{ vlan40_service.hostname }}"
        address="{{ vlan40_service.address }}"
        section="$(uci -q show dhcp | grep -F ".name='${hostname}'" | head -n1 | cut -d'.' -f2)"
        if [ -z "${section}" ]; then
          section="$(uci add dhcp host)"
        fi
        uci set dhcp.${section}.name="${hostname}"
        uci set dhcp.${section}.ip="${address}"
        uci commit dhcp

    - name: Restart dnsmasq after hostname updates
      ansible.builtin.raw: "/etc/init.d/dnsmasq restart"
      changed_when: false

    # Ensure the Tailscale package is installed and running.
    - name: Install Tailscale
      ansible.builtin.include_tasks: tasks/install-tailscale.yml

    # Configure Tailscale routes and auth key on the router.
    - name: Configure Tailscale
      ansible.builtin.include_tasks: tasks/configure-tailscale.yml

    # Track whether any task changed router state to decide snapshot cleanup.
    - name: Determine whether apply changed router state
      ansible.builtin.set_fact:
        apply_changed: >-
          {{ uci_apply_results is defined and
          (uci_apply_results.results | selectattr('changed') | list | length > 0) }}

    # Remove the snapshot when nothing changed to keep the repo clean.
    - name: Remove snapshot if no changes were applied
      ansible.builtin.file:
        path: "{{ hostvars['localhost'].snapshot_dir }}"
        state: absent
      when:
        - not apply_changed
        - hostvars['localhost'].snapshot_dir is defined
      delegate_to: localhost
      run_once: true

  handlers: []
