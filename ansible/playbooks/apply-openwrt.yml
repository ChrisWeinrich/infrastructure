---
- name: Apply OpenWrt configuration in staged steps
  hosts: openwrt
  gather_facts: false
  vars:
    uci_files: "{{ openwrt_uci_files | default([]) }}"
    openwrt_hostname: mt6000
    openwrt_apply_full: false
    openwrt_apply_pause: true
  tasks:
    - name: Set snapshot root
      ansible.builtin.set_fact:
        snapshot_root: >-
          {{ lookup('pipe', 'cd ' + playbook_dir + '/../.. && pwd') }}/{{ openwrt_snapshot_root | default('snapshots') }}
      delegate_to: localhost
      run_once: true

    - name: Set snapshot timestamp
      ansible.builtin.set_fact:
        snapshot_ts: "{{ lookup('pipe', 'date -u +%Y%m%dT%H%M%SZ') }}"
      delegate_to: localhost
      run_once: true

    - name: Set snapshot directory
      ansible.builtin.set_fact:
        snapshot_dir: "{{ snapshot_root }}/{{ openwrt_router_name }}/{{ snapshot_ts }}"
      delegate_to: localhost
      run_once: true

    - name: Ensure snapshot directory exists
      ansible.builtin.file:
        path: "{{ snapshot_dir }}"
        state: directory
        mode: "0750"
      delegate_to: localhost
      run_once: true

    - name: Read UCI configuration files
      ansible.builtin.raw: "cat {{ openwrt_config_dir }}/{{ item }}"
      loop: "{{ uci_files }}"
      register: openwrt_configs
      changed_when: false

    - name: Write snapshot files
      ansible.builtin.copy:
        dest: "{{ snapshot_dir }}/{{ item.item }}"
        content: >-
          {{ (item.stdout
          | replace("\r", "")
          | regex_replace("(?m)^.*option key.*\\n?", "")
          ) if item.item == 'wireless' else (item.stdout | replace("\r", "")) }}
        mode: "0440"
      loop: "{{ openwrt_configs.results }}"
      delegate_to: localhost
      run_once: true

    - name: Strip wireless keys from snapshot
      ansible.builtin.command: >-
        sed -i '' -E '/^[[:space:]]*option[[:space:]]+key[[:space:]]+/d' {{ snapshot_dir }}/wireless
      when: "'wireless' in uci_files"
      delegate_to: localhost
      run_once: true

    - name: Normalize wireless snapshot line endings
      ansible.builtin.command: >-
        sed -i '' -e 's/\\r$//' {{ snapshot_dir }}/wireless
      when: "'wireless' in uci_files"
      delegate_to: localhost
      run_once: true

    - name: Apply first small change (hostname)
      ansible.builtin.raw: |
        current="$(uci -q get system.@system[0].hostname)"
        if [ "$current" != "{{ openwrt_hostname }}" ]; then
          uci set system.@system[0].hostname="{{ openwrt_hostname }}"
          uci commit system
          echo changed
        fi
      register: hostname_apply
      changed_when: "'changed' in hostname_apply.stdout"

    - name: Reload system and dnsmasq when hostname changes
      ansible.builtin.raw: |
        /etc/init.d/system reload
        /etc/init.d/dnsmasq restart
      when: hostname_apply.changed

    - name: Install Tailscale
      ansible.builtin.include_tasks: tasks/install-tailscale.yml

    - name: Configure Tailscale
      ansible.builtin.include_tasks: tasks/configure-tailscale.yml
    - name: Determine whether apply changed router state
      ansible.builtin.set_fact:
        apply_changed: >-
          {{ hostname_apply.changed or
          (uci_apply_results is defined and
          (uci_apply_results.results | selectattr('changed') | list | length > 0)) }}

    - name: Remove snapshot if no changes were applied
      ansible.builtin.file:
        path: "{{ hostvars['localhost'].snapshot_dir }}"
        state: absent
      when:
        - not apply_changed
        - hostvars['localhost'].snapshot_dir is defined
      delegate_to: localhost
      run_once: true
