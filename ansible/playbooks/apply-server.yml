---
# Apply server hostname configuration
- name: Apply server hostname configuration
  hosts: servers
  gather_facts: true
  become: true
  vars_files:
    # Shared constants for container persistence paths.
    - "{{ playbook_dir }}/../vars/constants.yml"
  vars:
    server_hostname: atlas-host
    network_config_path: "{{ playbook_dir }}/../configs/network.yml"
    vlan_parent_interface_override: ""
    macvlan_network_name: "vlan40_macvlan"
    alpine_container_name: "vlan40-alpine"
    alpine_container_image: "alpine:latest"
    alpine_service_key: alpine_service
    jellyfin_container_name: "vlan40-jellyfin"
    jellyfin_container_image: "jellyfin/jellyfin:latest"
    jellyfin_service_key: jellyfin_service
    install_container_volumes_base_path: "{{ container_volumes_base_path }}"
    install_jellyfin_metadata_path: "{{ jellyfin_metadata_path }}"
  tasks:
    # Ensure the server hostname matches the inventory name.
    - name: Set server hostname
      ansible.builtin.hostname:
        name: "{{ server_hostname }}"

    # Apply host VLAN configuration (non-Docker).
    - name: Apply host VLAN role
      ansible.builtin.include_role:
        name: vlan
      vars:
        vlan_key: vlan40
        vlan_service_key: "{{ jellyfin_service_key }}"

    # Apply host hardware setup (USB disks).
    - name: Apply host USB drives role
      ansible.builtin.include_role:
        name: usb-drives

    # Apply Docker install and basic setup.
    - name: Apply Docker install role
      ansible.builtin.include_role:
        name: install

    # Run pre-configuration IaC for GitHub runner (before Compose).
    - name: Apply GitHub runner app IaC (pre)
      ansible.builtin.include_role:
        name: github-runner
        tasks_from: pre.yml

    # Apply GitHub Actions runner setup.
    - name: Apply GitHub runner app role
      ansible.builtin.include_role:
        name: github-runner

    # Start GitHub runner via Docker Compose.
    - name: Run GitHub runner via Compose
      ansible.builtin.include_role:
        name: compose
      vars:
        compose_project_name: "github-runner"
        compose_template: "{{ playbook_dir }}/../roles/apps/github-runner/templates/compose.yml.j2"

    # Run post-configuration IaC for GitHub runner (after Compose).
    - name: Apply GitHub runner app IaC (post)
      ansible.builtin.include_role:
        name: github-runner
        tasks_from: post.yml

    # Apply Docker VLAN setup for the selected VLAN/service.
    - name: Apply Docker macvlan role
      ansible.builtin.include_role:
        name: macvlan
      vars:
        macvlan_subnet: "{{ vlan_config.subnet }}"
        macvlan_gateway: "{{ vlan_config.gateway }}"
        macvlan_parent_interface: "{{ vlan_config.server.interface }}"

    # Run pre-configuration IaC for Jellyfin (before Compose).
    - name: Apply Jellyfin app IaC (pre)
      ansible.builtin.include_role:
        name: jellyfin
        tasks_from: pre.yml

    # Validate Jellyfin configuration values.
    - name: Validate Jellyfin app configuration
      ansible.builtin.include_role:
        name: jellyfin
        tasks_from: main.yml

    # Start Jellyfin via Docker Compose on the VLAN network.
    - name: Run Jellyfin via Compose
      ansible.builtin.include_role:
        name: compose
      vars:
        compose_project_name: jellyfin
        compose_template: "{{ playbook_dir }}/../roles/apps/jellyfin/templates/compose.yml.j2"
        compose_network_name: "{{ macvlan_network_name }}"
        compose_container_name: "{{ jellyfin_container_name }}"
        compose_container_image: "{{ jellyfin_container_image }}"
        compose_container_ip: "{{ vlan_service.address }}"

    # Run post-configuration IaC for Jellyfin (after Compose).
    - name: Apply Jellyfin app IaC (post)
      ansible.builtin.include_role:
        name: jellyfin
        tasks_from: post.yml

    # Run pre-configuration IaC for alpine (before Compose).
    - name: Apply alpine app IaC (pre)
      ansible.builtin.include_role:
        name: alpine
        tasks_from: pre.yml

    # Start alpine via Docker Compose on the VLAN network.
    - name: Run alpine via Compose
      ansible.builtin.include_role:
        name: compose
      vars:
        compose_project_name: alpine
        compose_template: "{{ playbook_dir }}/../roles/apps/alpine/templates/compose.yml.j2"
        compose_network_name: "{{ macvlan_network_name }}"
        compose_container_name: "{{ alpine_container_name }}"
        compose_container_image: "{{ alpine_container_image }}"
        compose_container_ip: "{{ network_config.site.services[alpine_service_key].address }}"

    # Run post-configuration IaC for alpine (after Compose).
    - name: Apply alpine app IaC (post)
      ansible.builtin.include_role:
        name: alpine
        tasks_from: post.yml
