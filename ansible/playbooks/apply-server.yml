---
# Apply server hostname configuration
- name: Apply server hostname configuration
  hosts: servers
  gather_facts: true
  become: true
  vars:
    server_hostname: atlas-host
    network_config_path: "{{ playbook_dir }}/../configs/network.yml"
    vlan_parent_interface_override: ""
    macvlan_network_name: "vlan40_macvlan"
    nginx_container_name: "vlan40-hello-nginx"
    nginx_container_image: "nginx:alpine"
    alpine_container_name: "vlan40-alpine"
    alpine_container_image: "alpine:latest"
    alpine_service_key: alpine_service
  tasks:
    # Ensure the server hostname matches the inventory name.
    - name: Set server hostname
      ansible.builtin.hostname:
        name: "{{ server_hostname }}"

    # Apply host VLAN configuration (non-Docker).
    - name: Apply host VLAN role
      ansible.builtin.include_role:
        name: vlan
      vars:
        vlan_key: vlan40
        vlan_service_key: hello_world_nginx

    # Apply host hardware setup (USB disks).
    - name: Apply host USB drives role
      ansible.builtin.include_role:
        name: usb-drives

    # Apply Docker install and basic setup.
    - name: Apply Docker install role
      ansible.builtin.include_role:
        name: install

    # Apply Docker VLAN setup for the selected VLAN/service.
    - name: Apply Docker macvlan role
      ansible.builtin.include_role:
        name: macvlan
      vars:
        macvlan_subnet: "{{ vlan_config.subnet }}"
        macvlan_gateway: "{{ vlan_config.gateway }}"
        macvlan_parent_interface: "{{ vlan_config.server.interface }}"
        macvlan_network_name: "{{ macvlan_network_name }}"

    # Run pre-configuration IaC for nginx (before Compose).
    - name: Apply nginx app IaC (pre)
      ansible.builtin.include_role:
        name: nginx
        tasks_from: pre.yml

    # Start nginx via Docker Compose on the VLAN network.
    - name: Run nginx via Compose
      ansible.builtin.include_role:
        name: compose
      vars:
        compose_project_name: nginx
        compose_template: "{{ playbook_dir }}/../roles/apps/nginx/templates/compose.yml.j2"
        compose_network_name: "{{ macvlan_network_name }}"
        compose_container_name: "{{ nginx_container_name }}"
        compose_container_image: "{{ nginx_container_image }}"
        compose_container_ip: "{{ vlan_service.address }}"

    # Run post-configuration IaC for nginx (after Compose).
    - name: Apply nginx app IaC (post)
      ansible.builtin.include_role:
        name: nginx
        tasks_from: post.yml

    # Run pre-configuration IaC for alpine (before Compose).
    - name: Apply alpine app IaC (pre)
      ansible.builtin.include_role:
        name: alpine
        tasks_from: pre.yml

    # Start alpine via Docker Compose on the VLAN network.
    - name: Run alpine via Compose
      ansible.builtin.include_role:
        name: compose
      vars:
        compose_project_name: alpine
        compose_template: "{{ playbook_dir }}/../roles/apps/alpine/templates/compose.yml.j2"
        compose_network_name: "{{ macvlan_network_name }}"
        compose_container_name: "{{ alpine_container_name }}"
        compose_container_image: "{{ alpine_container_image }}"
        compose_container_ip: "{{ network_config.site.services[alpine_service_key].address }}"

    # Run post-configuration IaC for alpine (after Compose).
    - name: Apply alpine app IaC (post)
      ansible.builtin.include_role:
        name: alpine
        tasks_from: post.yml
