---
# Apply server hostname configuration
- name: Apply server hostname configuration
  hosts: servers
  gather_facts: true
  become: true
  vars:
    server_hostname: atlas-host
    network_config_path: "{{ playbook_dir }}/../configs/network.yml"
    host_vlan_parent_interface_override: ""
    docker_vlan_network_name: "vlan40_macvlan"
    nginx_container_name: "vlan40-hello-nginx"
    nginx_container_image: "nginx:alpine"
    alpine_container_name: "vlan40-alpine"
    alpine_container_image: "alpine:latest"
    alpine_service_key: alpine_service
  tasks:
    # Ensure the server hostname matches the inventory name.
    - name: Set server hostname
      ansible.builtin.hostname:
        name: "{{ server_hostname }}"

    # Apply host VLAN configuration (non-Docker).
    - name: Apply host VLAN role
      ansible.builtin.include_role:
        name: host/network/vlan
      vars:
        host_vlan_key: vlan40
        host_vlan_service_key: hello_world_nginx

    # Apply Docker install and basic setup.
    - name: Apply Docker install role
      ansible.builtin.include_role:
        name: host/docker/install

    # Apply Docker VLAN setup for the selected VLAN/service.
    - name: Apply Docker VLAN role
      ansible.builtin.include_role:
        name: host/docker/vlan
      vars:
        docker_vlan_subnet: "{{ host_vlan_config.subnet }}"
        docker_vlan_gateway: "{{ host_vlan_config.gateway }}"
        docker_vlan_parent_interface: "{{ host_vlan_config.server.interface }}"

    # Run pre-configuration IaC for nginx (before Compose).
    - name: Apply nginx app IaC (pre)
      ansible.builtin.include_role:
        name: apps/nginx
        tasks_from: pre.yml

    # Start nginx via Docker Compose on the VLAN network.
    - name: Run nginx via Compose
      ansible.builtin.include_role:
        name: host/docker/compose
      vars:
        compose_project_name: nginx
        compose_template: "{{ playbook_dir }}/../roles/apps/nginx/templates/compose.yml.j2"
        compose_network_name: "{{ docker_vlan_network_name }}"
        nginx_container_ip: "{{ host_vlan_service.address }}"

    # Run post-configuration IaC for nginx (after Compose).
    - name: Apply nginx app IaC (post)
      ansible.builtin.include_role:
        name: apps/nginx
        tasks_from: post.yml

    # Run pre-configuration IaC for alpine (before Compose).
    - name: Apply alpine app IaC (pre)
      ansible.builtin.include_role:
        name: apps/alpine
        tasks_from: pre.yml

    # Start alpine via Docker Compose on the VLAN network.
    - name: Run alpine via Compose
      ansible.builtin.include_role:
        name: host/docker/compose
      vars:
        compose_project_name: alpine
        compose_template: "{{ playbook_dir }}/../roles/apps/alpine/templates/compose.yml.j2"
        compose_network_name: "{{ docker_vlan_network_name }}"
        alpine_container_ip: "{{ network_config.site.services[alpine_service_key].address }}"

    # Run post-configuration IaC for alpine (after Compose).
    - name: Apply alpine app IaC (post)
      ansible.builtin.include_role:
        name: apps/alpine
        tasks_from: post.yml

    # Apply host hardware setup (USB disks).
    - name: Apply host USB drives role
      ansible.builtin.include_role:
        name: host/hardware/usb-drives
