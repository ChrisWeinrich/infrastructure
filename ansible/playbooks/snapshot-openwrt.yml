---
- name: Capture OpenWrt configuration snapshot
  hosts: openwrt
  gather_facts: false
  strategy: linear
  vars:
    # Snapshot only the configured UCI files.
    uci_files: "{{ openwrt_uci_files | default([]) }}"
  tasks:
    # Resolve the snapshot root directory on the control host.
    - name: Set snapshot root
      ansible.builtin.set_fact:
        snapshot_root: >-
          {{ lookup('pipe', 'cd ' + playbook_dir + '/../.. && pwd')
             ~ '/' ~ (openwrt_snapshot_root | default('snapshots')) }}
      delegate_to: localhost
      run_once: true

    # Use a UTC timestamp so snapshots are sortable and unambiguous.
    - name: Set snapshot timestamp
      ansible.builtin.set_fact:
        snapshot_ts: "{{ lookup('pipe', 'date -u +%Y%m%dT%H%M%SZ') }}"
      delegate_to: localhost
      run_once: true

    # Compose the router-specific snapshot directory path.
    - name: Set snapshot directory
      ansible.builtin.set_fact:
        snapshot_dir: "{{ snapshot_root }}/{{ openwrt_router_name }}/{{ snapshot_ts }}"
      delegate_to: localhost
      run_once: true

    # Ensure the snapshot directory exists before writing files.
    - name: Ensure snapshot directory exists
      ansible.builtin.file:
        path: "{{ snapshot_dir }}"
        state: directory
        mode: "0750"
      delegate_to: localhost
      run_once: true

    # Read each UCI config file from the router.
    - name: Read UCI configuration files
      ansible.builtin.raw: "cat {{ openwrt_config_dir }}/{{ item }}"
      loop: "{{ uci_files }}"
      register: openwrt_configs
      changed_when: false

    # Write snapshot files locally, stripping wireless keys for safety.
    - name: Write snapshot files
      ansible.builtin.copy:
        dest: "{{ snapshot_dir }}/{{ item.item }}"
        content: >-
          {{ (item.stdout
          | replace("\r", "")
          | regex_replace("(?m)^.*option key.*\\n?", ""))
          if item.item == 'wireless' else (item.stdout | replace("\r", "")) }}
        mode: "0440"
      loop: "{{ openwrt_configs.results }}"
      delegate_to: localhost
      run_once: true

    # Remove any remaining wireless key lines from the snapshot.
    - name: Strip wireless keys from snapshot
      ansible.builtin.lineinfile:
        path: "{{ snapshot_dir }}/wireless"
        regexp: "^[[:space:]]*option[[:space:]]+key[[:space:]]+"
        state: absent
      when: "'wireless' in uci_files"
      delegate_to: localhost
      run_once: true

    # Normalize line endings to avoid diffs caused by CRLF.
    - name: Normalize wireless snapshot line endings
      ansible.builtin.replace:
        path: "{{ snapshot_dir }}/wireless"
        regexp: "\\r$"
        replace: ""
      when: "'wireless' in uci_files"
      delegate_to: localhost
      run_once: true
