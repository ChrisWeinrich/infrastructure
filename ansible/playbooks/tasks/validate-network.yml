---
# Validate the central network configuration for conflicts and missing data.

- name: Load central network configuration
  ansible.builtin.include_vars:
    file: "{{ playbook_dir }}/../configs/network.yml"
    name: network_config
  delegate_to: localhost
  run_once: true

- name: Ensure site and networks are defined
  ansible.builtin.assert:
    that:
      - network_config.site is defined
      - network_config.site.networks is defined
      - network_config.site.networks | length > 0
    fail_msg: "Network configuration must define site networks."
  delegate_to: localhost
  run_once: true

- name: Initialize device collection
  ansible.builtin.set_fact:
    network_devices: []
  delegate_to: localhost
  run_once: true

- name: Collect routers and attached devices
  ansible.builtin.set_fact:
    network_devices: >-
      {{ network_devices
         + [network_item.value.router]
         + (network_item.value.router.attached_devices | default({})
            | dict2items
            | map(attribute='value')
            | list) }}
  loop: "{{ network_config.site.networks | dict2items }}"
  loop_control:
    loop_var: network_item
  when: network_item.value.router is defined
  delegate_to: localhost
  run_once: true

- name: Ensure each network defines a router
  ansible.builtin.assert:
    that:
      - network_item.value.router is defined
      - network_item.value.router.name is defined
      - network_item.value.router.management_address is defined
    fail_msg: "Each network must define a router with name and address."
  loop: "{{ network_config.site.networks | dict2items }}"
  loop_control:
    loop_var: network_item
  delegate_to: localhost
  run_once: true

- name: Filter devices with declared names
  ansible.builtin.set_fact:
    named_devices: >-
      {{ network_devices | selectattr('name', 'defined') | list }}
  delegate_to: localhost
  run_once: true

- name: Ensure all devices include required fields
  ansible.builtin.assert:
    that:
      - device_item.name is defined
      - device_item.management_address is defined
    fail_msg: "Every device must include name and management_address."
  loop: "{{ named_devices }}"
  loop_control:
    loop_var: device_item
  delegate_to: localhost
  run_once: true

- name: Collect hostnames and addresses
  ansible.builtin.set_fact:
    device_hostnames: "{{ named_devices | map(attribute='name') | list }}"
    device_addresses: >-
      {{ named_devices | map(attribute='management_address') | list }}
  delegate_to: localhost
  run_once: true

- name: Detect duplicate hostnames
  ansible.builtin.assert:
    that:
      - device_hostnames | length == (device_hostnames | unique | length)
    fail_msg: "Duplicate hostnames detected in network configuration."
  delegate_to: localhost
  run_once: true

- name: Detect duplicate management addresses
  ansible.builtin.assert:
    that:
      - device_addresses | length == (device_addresses | unique | length)
    fail_msg: "Duplicate management addresses detected in network configuration."
  delegate_to: localhost
  run_once: true

- name: Collect MAC addresses for validation
  ansible.builtin.set_fact:
    device_macs: >-
      {{ named_devices
         | selectattr('mac_address', 'defined')
         | map(attribute='mac_address')
         | list }}
  delegate_to: localhost
  run_once: true

- name: Validate MAC address format
  ansible.builtin.assert:
    that:
      - device_macs
        | map('lower')
        | select('match', '^[0-9a-f]{2}(:[0-9a-f]{2}){5}$')
        | list
        | length
        == device_macs | length
    fail_msg: "Invalid MAC address format found in network configuration."
  delegate_to: localhost
  run_once: true
