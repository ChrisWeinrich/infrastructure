---
- name: Verify OpenWrt connectivity and baseline checks
  hosts: openwrt
  gather_facts: false
  vars:
    # Verify only the configured UCI files.
    uci_files: "{{ openwrt_uci_files | default([]) }}"
  tasks:
    # Confirm basic SSH access before any other checks.
    - name: Verify SSH connectivity
      ansible.builtin.raw: "echo ok"
      register: ssh_check
      changed_when: false

    # Fail fast if SSH is unavailable.
    - name: Gate on SSH connectivity
      ansible.builtin.assert:
        that:
          - ssh_check.rc == 0
        fail_msg: "SSH connectivity check failed. Stop and recover access."

    # Read each UCI config to confirm router accessibility.
    - name: Read UCI configuration files
      ansible.builtin.raw: "uci show {{ item }}"
      loop: "{{ uci_files }}"
      register: uci_reads
      changed_when: false

    # Stop if any UCI read failed.
    - name: Gate on UCI reads
      ansible.builtin.assert:
        that:
          - uci_reads.results | map(attribute='rc') | list | max == 0
        fail_msg: "One or more UCI read checks failed."

    # Validate the central network configuration before deeper checks.
    - name: Validate central network configuration
      ansible.builtin.include_tasks: tasks/validate-network.yml

    # Validate DNS resolution from the router.
    - name: Verify DNS resolution from the router
      ansible.builtin.raw: "nslookup {{ openwrt_verify_dns_domain }}"
      register: dns_check
      changed_when: false

    # Stop if DNS resolution failed.
    - name: Gate on DNS resolution
      ansible.builtin.assert:
        that:
          - dns_check.rc == 0
        fail_msg: "DNS resolution failed on the router."

    # Validate HTTP reachability from the router.
    - name: Verify HTTP reachability from the router
      ansible.builtin.raw: "wget -q --spider {{ openwrt_verify_http_url }}"
      register: http_check
      changed_when: false

    # Stop if HTTP reachability failed.
    - name: Gate on HTTP reachability
      ansible.builtin.assert:
        that:
          - http_check.rc == 0
        fail_msg: "HTTP reachability failed on the router."

    # Ensure the Tailscale binary is present.
    - name: Verify Tailscale binary is available
      ansible.builtin.raw: "command -v tailscale"
      register: tailscale_binary
      changed_when: false

    # Stop if the Tailscale binary is missing.
    - name: Gate on Tailscale availability
      ansible.builtin.assert:
        that:
          - tailscale_binary.rc == 0
        fail_msg: "Tailscale binary not found on the router."

    # Capture Tailscale status for route validation.
    - name: Capture Tailscale status
      ansible.builtin.raw: "tailscale status --json"
      register: tailscale_status
      changed_when: false

    # Stop if Tailscale status failed.
    - name: Gate on Tailscale status
      ansible.builtin.assert:
        that:
          - tailscale_status.rc == 0
        fail_msg: "Tailscale status check failed."

    # Parse the status output into structured data.
    - name: Parse Tailscale status JSON
      ansible.builtin.set_fact:
        tailscale_status_json: "{{ tailscale_status.stdout | from_json }}"

    # Extract advertised and allowed route data.
    - name: Collect Tailscale route data
      ansible.builtin.set_fact:
        tailscale_advertised_routes: >-
          {{ tailscale_status_json.Self.AdvertisedRoutes | default([]) }}
        tailscale_primary_routes: >-
          {{ tailscale_status_json.Self.PrimaryRoutes | default([]) }}
        tailscale_allowed_ips: >-
          {{ tailscale_status_json.Self.AllowedIPs | default([]) }}

    # Log route data for verification output.
    - name: Record advertised routes
      ansible.builtin.debug:
        msg: >-
          Advertised routes:
          {{ tailscale_advertised_routes }}
          Primary routes:
          {{ tailscale_primary_routes }}
          Allowed IPs:
          {{ tailscale_allowed_ips }}
