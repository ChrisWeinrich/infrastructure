---
- name: Verify OpenWrt connectivity and baseline checks
  hosts: openwrt
  gather_facts: false
  vars:
    # Verify only the configured UCI files.
    uci_files: "{{ openwrt_uci_files | default([]) }}"
    network_config_path: "{{ playbook_dir }}/../configs/network.yml"
  tasks:
    # Confirm basic SSH access before any other checks.
    - name: Verify SSH connectivity
      ansible.builtin.raw: "echo ok"
      register: ssh_check
      changed_when: false

    # Fail fast if SSH is unavailable.
    - name: Gate on SSH connectivity
      ansible.builtin.assert:
        that:
          - ssh_check.rc == 0
        fail_msg: "SSH connectivity check failed. Stop and recover access."

    # Read each UCI config to confirm router accessibility.
    - name: Read UCI configuration files
      ansible.builtin.raw: "uci show {{ item }}"
      loop: "{{ uci_files }}"
      register: uci_reads
      changed_when: false

    # Stop if any UCI read failed.
    - name: Gate on UCI reads
      ansible.builtin.assert:
        that:
          - uci_reads.results | map(attribute='rc') | list | max == 0
        fail_msg: "One or more UCI read checks failed."

    # Validate the central network configuration before deeper checks.
    - name: Validate central network configuration
      ansible.builtin.include_tasks: tasks/validate-network.yml

    - name: Load central network configuration
      ansible.builtin.include_vars:
        file: "{{ network_config_path }}"
        name: network_config

    - name: Select VLAN 40 and service configuration
      ansible.builtin.set_fact:
        vlan40_config: "{{ network_config.site.networks.vlan40 }}"
        vlan40_service: "{{ network_config.site.services.hello_world_nginx }}"

    - name: Verify VLAN 40 interface configuration
      ansible.builtin.raw: "uci -q get network.vlan40.ipaddr"
      register: vlan40_ipaddr
      changed_when: false

    - name: Gate on VLAN 40 interface configuration
      ansible.builtin.assert:
        that:
          - vlan40_ipaddr.stdout | trim == vlan40_config.gateway
        fail_msg: "VLAN 40 interface is missing or has the wrong IP."

    - name: Verify firewall zone for VLAN 40
      ansible.builtin.raw: "uci -q get firewall.vlan40.name"
      register: vlan40_zone
      changed_when: false

    - name: Gate on firewall zone for VLAN 40
      ansible.builtin.assert:
        that:
          - vlan40_zone.stdout | trim == "vlan40"
        fail_msg: "Firewall zone vlan40 is missing or misconfigured."

    - name: Verify DNS host entry for VLAN service
      ansible.builtin.raw: >-
        uci -q show dhcp
        | grep -F ".name='{{ vlan40_service.hostname }}'"
      register: vlan40_dns
      changed_when: false
      failed_when: false

    - name: Gate on DNS host entry for VLAN service
      ansible.builtin.assert:
        that:
          - vlan40_dns.rc == 0
        fail_msg: "DNS host entry for nginx-vlan40 is missing."

    # Validate DNS resolution from the router.
    - name: Verify DNS resolution from the router
      ansible.builtin.raw: "nslookup {{ openwrt_verify_dns_domain }}"
      register: dns_check
      changed_when: false

    # Stop if DNS resolution failed.
    - name: Gate on DNS resolution
      ansible.builtin.assert:
        that:
          - dns_check.rc == 0
        fail_msg: "DNS resolution failed on the router."

    # Validate HTTP reachability from the router.
    - name: Verify HTTP reachability from the router
      ansible.builtin.raw: "wget -q --spider {{ openwrt_verify_http_url }}"
      register: http_check
      changed_when: false

    # Stop if HTTP reachability failed.
    - name: Gate on HTTP reachability
      ansible.builtin.assert:
        that:
          - http_check.rc == 0
        fail_msg: "HTTP reachability failed on the router."

    # Ensure the Tailscale binary is present.
    - name: Verify Tailscale binary is available
      ansible.builtin.raw: "command -v tailscale"
      register: tailscale_binary
      changed_when: false

    # Stop if the Tailscale binary is missing.
    - name: Gate on Tailscale availability
      ansible.builtin.assert:
        that:
          - tailscale_binary.rc == 0
        fail_msg: "Tailscale binary not found on the router."

    # Capture Tailscale status for route validation.
    - name: Capture Tailscale status
      ansible.builtin.raw: "tailscale status --json"
      register: tailscale_status
      changed_when: false

    # Stop if Tailscale status failed.
    - name: Gate on Tailscale status
      ansible.builtin.assert:
        that:
          - tailscale_status.rc == 0
        fail_msg: "Tailscale status check failed."

    # Parse the status output into structured data.
    - name: Parse Tailscale status JSON
      ansible.builtin.set_fact:
        tailscale_status_json: "{{ tailscale_status.stdout | from_json }}"

    # Extract advertised and allowed route data.
    - name: Collect Tailscale route data
      ansible.builtin.set_fact:
        tailscale_advertised_routes: >-
          {{ tailscale_status_json.Self.AdvertisedRoutes | default([]) }}
        tailscale_primary_routes: >-
          {{ tailscale_status_json.Self.PrimaryRoutes | default([]) }}
        tailscale_allowed_ips: >-
          {{ tailscale_status_json.Self.AllowedIPs | default([]) }}

    # Log route data for verification output.
    - name: Record advertised routes
      ansible.builtin.debug:
        msg: >-
          Advertised routes:
          {{ tailscale_advertised_routes }}
          Primary routes:
          {{ tailscale_primary_routes }}
          Allowed IPs:
          {{ tailscale_allowed_ips }}

    - name: Gate on Tailscale route for VLAN 40
      ansible.builtin.assert:
        that:
          - "'192.168.40.0/24' in tailscale_advertised_routes"
        fail_msg: "Tailscale route for VLAN 40 is not advertised."
