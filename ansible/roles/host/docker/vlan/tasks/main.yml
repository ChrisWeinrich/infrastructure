---
# Configure Docker macvlan network.

- name: Validate Docker VLAN variables
  # Ensure required Docker VLAN variables are set.
  ansible.builtin.assert:
    that:
      - docker_vlan_subnet is string
      - docker_vlan_subnet | length > 0
      - docker_vlan_gateway is string
      - docker_vlan_gateway | length > 0
      - docker_vlan_parent_interface is string
      - docker_vlan_parent_interface | length > 0
    fail_msg: "Docker VLAN configuration is incomplete."

- name: Check Docker macvlan network
  # Check if the Docker macvlan network already exists.
  ansible.builtin.command: "docker network inspect {{ docker_vlan_network_name }}"
  register: docker_network_check
  changed_when: false
  failed_when: false

- name: Create Docker macvlan network
  # Create the Docker macvlan network when missing.
  ansible.builtin.command: >-
    docker network create -d macvlan
    --subnet {{ docker_vlan_subnet }}
    --gateway {{ docker_vlan_gateway }}
    -o parent={{ docker_vlan_parent_interface }}
    {{ docker_vlan_network_name }}
  changed_when: true
  when: docker_network_check.rc != 0
