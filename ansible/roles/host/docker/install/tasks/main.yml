---
# Install Docker engine and compose tooling.

- name: Check for Docker Compose plugin package
  # Detect whether the compose plugin package is available.
  ansible.builtin.command: apt-cache show docker-compose-plugin
  register: install_docker_compose_plugin_check
  changed_when: false
  failed_when: false

- name: Select Docker packages based on availability
  # Prefer compose plugin if available, otherwise fallback package.
  ansible.builtin.set_fact:
    install_docker_packages_selected: >-
      {{ install_docker_packages_primary
      if install_docker_compose_plugin_check.rc == 0
      else install_docker_packages_fallback }}

- name: Install Docker Engine and Compose package
  # Install Docker engine and compose tooling.
  ansible.builtin.apt:
    name: "{{ install_docker_packages_selected }}"
    state: present
    update_cache: true

- name: Ensure Docker service is enabled and running
  # Start and enable Docker service.
  ansible.builtin.service:
    name: docker
    state: started
    enabled: true

- name: Ensure container volumes base path exists
  # Create a single persistence root for container volumes.
  ansible.builtin.file:
    path: "{{ install_container_volumes_base_path }}"
    state: directory
    mode: "0755"

- name: Ensure Jellyfin metadata directory exists
  # Prepare persistent metadata storage for Jellyfin.
  ansible.builtin.file:
    path: "{{ install_jellyfin_metadata_path }}"
    state: directory
    mode: "0755"
