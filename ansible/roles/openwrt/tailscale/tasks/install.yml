---
# Determine whether the tailscale binary is present.
- name: Check if Tailscale is installed
  ansible.builtin.raw: "command -v tailscale"
  register: tailscale_binary
  changed_when: false
  failed_when: false

# Refresh package metadata before install/upgrade.
- name: Update package lists
  ansible.builtin.raw: "opkg update"
  register: tailscale_opkg_update
  changed_when: false
  failed_when: false

- name: Gate on package list update when install is required
  ansible.builtin.assert:
    that:
      - tailscale_binary.rc == 0 or tailscale_opkg_update.rc == 0
    fail_msg: >-
      opkg update failed and Tailscale is not installed. Check router
      connectivity to package feeds before retrying.

# Install tailscale if missing, otherwise upgrade it.
- name: Install or upgrade Tailscale
  ansible.builtin.raw: |
    if [ {{ tailscale_binary.rc }} -ne 0 ]; then
      opkg install tailscale
      echo changed
    else
      opkg upgrade tailscale
      echo changed
    fi
  register: tailscale_install
  changed_when: "'changed' in tailscale_install.stdout"
  when: tailscale_binary.rc == 0 or tailscale_opkg_update.rc == 0

# Ensure the tailscale service is enabled and running.
- name: Enable and start Tailscale service
  ansible.builtin.raw: |
    if [ -x /etc/init.d/tailscale ]; then
      /etc/init.d/tailscale enable
      /etc/init.d/tailscale start
    fi
  changed_when: false
